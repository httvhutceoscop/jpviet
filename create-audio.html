<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>T·∫°o Audio MP3 - JPVIET</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="T·∫°o file audio MP3 cho t·ª´ v·ª±ng ti·∫øng Nh·∫≠t" />
  <meta name="theme-color" content="#f15b5b" />
  
  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />
  
  <style>
    .audio-creator {
      padding: 40px 20px;
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .creator-section {
      margin-bottom: 40px;
      padding: 24px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: white;
    }
    
    .creator-title {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 24px;
      text-align: center;
    }
    
    .audio-form {
      display: grid;
      gap: 20px;
      margin-bottom: 24px;
    }
    
    .form-group {
      display: grid;
      gap: 8px;
    }
    
    .form-group label {
      font-weight: bold;
      color: var(--fg);
    }
    
    .form-group input,
    .form-group select {
      padding: 12px;
      border-radius: 8px;
      border: 2px solid var(--border);
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 4px rgba(241, 91, 91, 0.1);
    }
    
    .audio-controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 24px;
    }
    
    .audio-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .audio-btn.primary {
      background: var(--primary);
      color: white;
    }
    
    .audio-btn.secondary {
      background: #6b7280;
      color: white;
    }
    
    .audio-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .audio-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .audio-preview {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .audio-player {
      margin: 16px 0;
    }
    
    .audio-player audio {
      width: 100%;
      max-width: 400px;
    }
    
    .vocab-list {
      display: grid;
      gap: 16px;
      margin-top: 24px;
    }
    
    .vocab-item {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 16px;
      align-items: center;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
      transition: all 0.3s ease;
    }
    
    .vocab-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .vocab-kanji {
      font-size: 18px;
      font-weight: bold;
    }
    
    .vocab-kana {
      color: var(--primary);
      font-size: 16px;
    }
    
    .vocab-meaning {
      color: var(--muted);
      font-size: 14px;
    }
    
    .vocab-actions {
      display: flex;
      gap: 8px;
    }
    
    .action-btn {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .action-btn.play {
      background: #10b981;
      color: white;
    }
    
    .action-btn.create {
      background: var(--primary);
      color: white;
    }
    
    .action-btn.download {
      background: #3b82f6;
      color: white;
    }
    
    .action-btn:hover {
      transform: scale(1.05);
    }
    
    .status {
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
      text-align: center;
      font-weight: bold;
    }
    
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #10b981;
    }
    
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #ef4444;
    }
    
    .status.info {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #3b82f6;
    }
    
    .batch-controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 24px 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #f1f1f1;
      border-radius: 10px;
      overflow: hidden;
      margin: 16px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #ff8a8a);
      width: 0%;
      transition: width 0.3s ease;
      position: relative;
    }
    
    .progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: progressShine 2s infinite;
    }
    
    @keyframes progressShine {
      0% { left: -100%; }
      100% { left: 100%; }
    }
  </style>
</head>
<body>
  <header class="site-header">
    <h1>üéµ T·∫°o Audio MP3</h1>
    <p>T·∫°o file audio cho t·ª´ v·ª±ng ti·∫øng Nh·∫≠t</p>
  </header>

  <main class="audio-creator">
    <!-- Audio Creator Form -->
    <div class="creator-section">
      <h2 class="creator-title">üé§ T·∫°o Audio ƒê∆°n L·∫ª</h2>
      
      <form class="audio-form" id="audioForm">
        <div class="form-group">
          <label for="textInput">VƒÉn b·∫£n ti·∫øng Nh·∫≠t:</label>
          <input type="text" id="textInput" placeholder="Nh·∫≠p vƒÉn b·∫£n ti·∫øng Nh·∫≠t..." required />
        </div>
        
        <div class="form-group">
          <label for="voiceSelect">Gi·ªçng ƒë·ªçc:</label>
          <select id="voiceSelect">
            <option value="">Ch·ªçn gi·ªçng ƒë·ªçc...</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="speedInput">T·ªëc ƒë·ªô ƒë·ªçc:</label>
          <input type="range" id="speedInput" min="0.5" max="2" step="0.1" value="1" />
          <span id="speedValue">1.0x</span>
        </div>
        
        <div class="form-group">
          <label for="pitchInput">Cao ƒë·ªô:</label>
          <input type="range" id="pitchInput" min="0.5" max="2" step="0.1" value="1" />
          <span id="pitchValue">1.0x</span>
        </div>
      </form>
      
      <div class="audio-controls">
        <button class="audio-btn primary" id="speakBtn">
          üîä Ph√°t √¢m
        </button>
        <button class="audio-btn secondary" id="createAudioBtn">
          üéµ T·∫°o MP3
        </button>
        <button class="audio-btn secondary" id="downloadBtn" disabled>
          üì• T·∫£i xu·ªëng
        </button>
      </div>
      
      <div class="audio-preview" id="audioPreview" style="display: none;">
        <h3>üéß Nghe th·ª≠</h3>
        <div class="audio-player">
          <audio id="audioPlayer" controls></audio>
        </div>
        <p class="muted">Nghe th·ª≠ audio ƒë√£ t·∫°o</p>
      </div>
    </div>

    <!-- Batch Audio Creator -->
    <div class="creator-section">
      <h2 class="creator-title">üìö T·∫°o Audio H√†ng Lo·∫°t</h2>
      
      <div class="batch-controls">
        <button class="audio-btn primary" id="loadVocabBtn">
          üìñ T·∫£i t·ª´ v·ª±ng
        </button>
        <button class="audio-btn secondary" id="createAllBtn" disabled>
          üéµ T·∫°o t·∫•t c·∫£
        </button>
        <button class="audio-btn secondary" id="downloadAllBtn" disabled>
          üì• T·∫£i t·∫•t c·∫£
        </button>
      </div>
      
      <div class="progress-bar" id="progressBar" style="display: none;">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      
      <div id="vocabList" class="vocab-list"></div>
    </div>

    <!-- Status Messages -->
    <div id="statusContainer"></div>
  </main>

  <footer class="site-footer">
    <p>¬© 2025 JPVIET.COM - Audio Creator</p>
  </footer>

  <!-- Scripts -->
  <script src="pwa.js"></script>
  <script src="sidebar.js"></script>
  
  <script>
    class AudioCreator {
      constructor() {
        this.synthesis = window.speechSynthesis;
        this.voices = [];
        this.audioBlob = null;
        this.vocabData = [];
        this.currentIndex = 0;
        this.isCreating = false;
        
        this.init();
      }
      
      init() {
        this.loadVoices();
        this.bindEvents();
        this.updateSpeedDisplay();
        this.updatePitchDisplay();
      }
      
      loadVoices() {
        // Load available voices
        const loadVoices = () => {
          this.voices = this.synthesis.getVoices();
          const voiceSelect = document.getElementById('voiceSelect');
          voiceSelect.innerHTML = '<option value="">Ch·ªçn gi·ªçng ƒë·ªçc...</option>';
          
          // Filter Japanese voices
          const japaneseVoices = this.voices.filter(voice => 
            voice.lang.includes('ja') || voice.lang.includes('JP')
          );
          
          // Add all voices if no Japanese voices found
          const voicesToShow = japaneseVoices.length > 0 ? japaneseVoices : this.voices;
          
          voicesToShow.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.name;
            option.textContent = `${voice.name} (${voice.lang})`;
            voiceSelect.appendChild(option);
          });
        };
        
        if (this.synthesis.onvoiceschanged !== undefined) {
          this.synthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();
      }
      
      bindEvents() {
        // Speed and pitch controls
        document.getElementById('speedInput').addEventListener('input', (e) => {
          this.updateSpeedDisplay();
        });
        
        document.getElementById('pitchInput').addEventListener('input', (e) => {
          this.updatePitchDisplay();
        });
        
        // Audio controls
        document.getElementById('speakBtn').addEventListener('click', () => {
          this.speak();
        });
        
        document.getElementById('createAudioBtn').addEventListener('click', () => {
          this.createAudio();
        });
        
        document.getElementById('downloadBtn').addEventListener('click', () => {
          this.downloadAudio();
        });
        
        // Batch controls
        document.getElementById('loadVocabBtn').addEventListener('click', () => {
          this.loadVocabData();
        });
        
        document.getElementById('createAllBtn').addEventListener('click', () => {
          this.createAllAudio();
        });
        
        document.getElementById('downloadAllBtn').addEventListener('click', () => {
          this.downloadAllAudio();
        });
      }
      
      updateSpeedDisplay() {
        const speed = document.getElementById('speedInput').value;
        document.getElementById('speedValue').textContent = speed + 'x';
      }
      
      updatePitchDisplay() {
        const pitch = document.getElementById('pitchInput').value;
        document.getElementById('pitchValue').textContent = pitch + 'x';
      }
      
      speak() {
        const text = document.getElementById('textInput').value;
        if (!text) {
          this.showStatus('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n!', 'error');
          return;
        }
        
        // Stop any current speech
        this.synthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.voice = this.voices.find(v => v.name === document.getElementById('voiceSelect').value);
        utterance.rate = parseFloat(document.getElementById('speedInput').value);
        utterance.pitch = parseFloat(document.getElementById('pitchInput').value);
        utterance.lang = 'ja-JP';
        
        this.synthesis.speak(utterance);
        this.showStatus('ƒêang ph√°t √¢m...', 'info');
      }
      
      async createAudio() {
        const text = document.getElementById('textInput').value;
        if (!text) {
          this.showStatus('Vui l√≤ng nh·∫≠p vƒÉn b·∫£n!', 'error');
          return;
        }
        
        try {
          this.showStatus('ƒêang t·∫°o audio...', 'info');
          
          // Create audio using Web Speech API and MediaRecorder
          const audioBlob = await this.createAudioBlob(text);
          this.audioBlob = audioBlob;
          
          // Create audio preview
          const audioUrl = URL.createObjectURL(audioBlob);
          const audioPlayer = document.getElementById('audioPlayer');
          audioPlayer.src = audioUrl;
          
          // Show preview
          document.getElementById('audioPreview').style.display = 'block';
          document.getElementById('downloadBtn').disabled = false;
          
          this.showStatus('ƒê√£ t·∫°o audio th√†nh c√¥ng!', 'success');
          
        } catch (error) {
          console.error('Error creating audio:', error);
          this.showStatus('L·ªói khi t·∫°o audio: ' + error.message, 'error');
        }
      }
      
      async createAudioBlob(text) {
        return new Promise((resolve, reject) => {
          try {
            // Create utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = this.voices.find(v => v.name === document.getElementById('voiceSelect').value);
            utterance.rate = parseFloat(document.getElementById('speedInput').value);
            utterance.pitch = parseFloat(document.getElementById('pitchInput').value);
            utterance.lang = 'ja-JP';
            
            // Create audio context for recording
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // Connect nodes
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Set audio properties
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            
            // Create MediaRecorder
            const stream = audioContext.createMediaStreamDestination().stream;
            const mediaRecorder = new MediaRecorder(stream);
            const chunks = [];
            
            mediaRecorder.ondataavailable = (event) => {
              chunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
              const blob = new Blob(chunks, { type: 'audio/mp3' });
              resolve(blob);
            };
            
            // Start recording and speaking
            mediaRecorder.start();
            this.synthesis.speak(utterance);
            
            // Stop recording after speech ends
            utterance.onend = () => {
              setTimeout(() => {
                mediaRecorder.stop();
                audioContext.close();
              }, 500);
            };
            
          } catch (error) {
            reject(error);
          }
        });
      }
      
      downloadAudio() {
        if (!this.audioBlob) {
          this.showStatus('Kh√¥ng c√≥ audio ƒë·ªÉ t·∫£i!', 'error');
          return;
        }
        
        const text = document.getElementById('textInput').value;
        const filename = `${text.replace(/[^a-zA-Z0-9]/g, '_')}.mp3`;
        
        const url = URL.createObjectURL(this.audioBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.showStatus(`ƒê√£ t·∫£i xu·ªëng: ${filename}`, 'success');
      }
      
      async loadVocabData() {
        try {
          this.showStatus('ƒêang t·∫£i d·ªØ li·ªáu t·ª´ v·ª±ng...', 'info');
          
          const response = await fetch('data/vocab.json');
          this.vocabData = await response.json();
          
          this.renderVocabList();
          document.getElementById('createAllBtn').disabled = false;
          
          this.showStatus(`ƒê√£ t·∫£i ${this.vocabData.length} t·ª´ v·ª±ng`, 'success');
          
        } catch (error) {
          console.error('Error loading vocab:', error);
          this.showStatus('L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ v·ª±ng', 'error');
        }
      }
      
      renderVocabList() {
        const vocabList = document.getElementById('vocabList');
        vocabList.innerHTML = '';
        
        this.vocabData.forEach((vocab, index) => {
          const vocabItem = document.createElement('div');
          vocabItem.className = 'vocab-item';
          
          vocabItem.innerHTML = `
            <div class="vocab-kanji">${vocab.kanji || '-'}</div>
            <div class="vocab-kana">${vocab.kana}</div>
            <div class="vocab-meaning">${vocab.meaning}</div>
            <div class="vocab-actions">
              <button class="action-btn play" onclick="audioCreator.playVocab(${index})">
                üîä
              </button>
              <button class="action-btn create" onclick="audioCreator.createVocabAudio(${index})">
                üéµ
              </button>
              <button class="action-btn download" onclick="audioCreator.downloadVocabAudio(${index})" disabled>
                üì•
              </button>
            </div>
          `;
          
          vocabList.appendChild(vocabItem);
        });
      }
      
      playVocab(index) {
        const vocab = this.vocabData[index];
        document.getElementById('textInput').value = vocab.kana;
        this.speak();
      }
      
      async createVocabAudio(index) {
        const vocab = this.vocabData[index];
        
        try {
          this.showStatus(`ƒêang t·∫°o audio cho: ${vocab.kana}`, 'info');
          
          const audioBlob = await this.createAudioBlob(vocab.kana);
          vocab.audioBlob = audioBlob;
          
          // Update UI
          const downloadBtn = document.querySelectorAll('.vocab-item')[index].querySelector('.action-btn.download');
          downloadBtn.disabled = false;
          
          this.showStatus(`ƒê√£ t·∫°o audio cho: ${vocab.kana}`, 'success');
          
        } catch (error) {
          console.error('Error creating vocab audio:', error);
          this.showStatus(`L·ªói khi t·∫°o audio cho: ${vocab.kana}`, 'error');
        }
      }
      
      downloadVocabAudio(index) {
        const vocab = this.vocabData[index];
        
        if (!vocab.audioBlob) {
          this.showStatus('Ch∆∞a c√≥ audio cho t·ª´ n√†y!', 'error');
          return;
        }
        
        const filename = `${vocab.kana.replace(/[^a-zA-Z0-9]/g, '_')}.mp3`;
        
        const url = URL.createObjectURL(vocab.audioBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        this.showStatus(`ƒê√£ t·∫£i xu·ªëng: ${filename}`, 'success');
      }
      
      async createAllAudio() {
        if (this.isCreating) return;
        
        this.isCreating = true;
        document.getElementById('createAllBtn').disabled = true;
        document.getElementById('progressBar').style.display = 'block';
        
        const total = this.vocabData.length;
        let completed = 0;
        
        for (let i = 0; i < total; i++) {
          if (!this.isCreating) break;
          
          try {
            await this.createVocabAudio(i);
            completed++;
            
            // Update progress
            const progress = (completed / total) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Small delay to prevent overwhelming the API
            await new Promise(resolve => setTimeout(resolve, 1000));
            
          } catch (error) {
            console.error(`Error creating audio for index ${i}:`, error);
          }
        }
        
        this.isCreating = false;
        document.getElementById('createAllBtn').disabled = false;
        document.getElementById('downloadAllBtn').disabled = false;
        
        this.showStatus(`ƒê√£ t·∫°o xong ${completed}/${total} audio files`, 'success');
      }
      
      downloadAllAudio() {
        const audioFiles = this.vocabData.filter(vocab => vocab.audioBlob);
        
        if (audioFiles.length === 0) {
          this.showStatus('Ch∆∞a c√≥ audio n√†o ƒë·ªÉ t·∫£i!', 'error');
          return;
        }
        
        // Create zip file or download individually
        audioFiles.forEach((vocab, index) => {
          setTimeout(() => {
            this.downloadVocabAudio(index);
          }, index * 100);
        });
        
        this.showStatus(`ƒêang t·∫£i xu·ªëng ${audioFiles.length} files...`, 'info');
      }
      
      showStatus(message, type) {
        const statusContainer = document.getElementById('statusContainer');
        const statusElement = document.createElement('div');
        statusElement.className = `status ${type}`;
        statusElement.textContent = message;
        
        statusContainer.appendChild(statusElement);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (statusElement.parentElement) {
            statusElement.remove();
          }
        }, 5000);
      }
    }
    
    // Initialize audio creator when page loads
    document.addEventListener('DOMContentLoaded', () => {
      window.audioCreator = new AudioCreator();
    });
  </script>
</body>
</html>
